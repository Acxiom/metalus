language: scala

jobs:
  allow_failures:
    - os: windows
  include:
  - stage: Build
    os: linux
    scala:
      - 2.11.12
    install: true
    script: mvn clean install
  -
    os: osx
    osx_image: xcode9.3
    scala:
      - 2.11.12
    install: true
    script: mvn clean install
  -
    os: windows
    language: shell
    install: true
    before_script:
      - choco install jdk8
      - choco install maven
    script: mvn clean install
  - stage: Coverage
    if: branch = develop
    os: linux
    scala:
      - 2.11.12
    install: true
    script: mvn -DrepoToken=$coverallsToken clean scoverage:report install scala:doc scalastyle:check coveralls:report
  - stage: Release
    if: branch = master AND type != pull_request AND fork = false AND repo = Acxiom/spark-pipeline-driver
    os: linux
    scala:
      - 2.11.12
    before_install:
      - openssl aes-256-cbc -K $encrypted_8c1245ae29b8_key -iv $encrypted_8c1245ae29b8_iv -in deployment/acxsigningkey.asc.enc -out deployment/acxsigningkey.asc -d
    install: true
    before_script:
      - mvn versions:set -DremoveSnapshot
      - gpg --keyring=$TRAVIS_BUILD_DIR/pubring.gpg --no-default-keyring --import deployment/acxsigningkey.asc
      - gpg --secret-keyring=$TRAVIS_BUILD_DIR/secring.gpg --no-default-keyring --import deployment/acxsigningkey.asc
    script: mvn --settings deployment/release-settings.xml -P release -DrepoToken=$coverallsToken -Dgpg.executable=gpg -Dgpg.keyname=77FEB4F0227ADB783C1E726F1B725518AF759196 -Dgpg.passphrase=$PASSPHRASE -Dgpg.publicKeyring=$TRAVIS_BUILD_DIR/pubring.gpg -Dgpg.secretKeyring=$TRAVIS_BUILD_DIR/secring.gpg clean scoverage:report scala:doc scalastyle:check coveralls:report deploy
    before_deploy:
      - export project_version=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
    deploy:
      provider: releases
      api_key: $GITHUB_OAUTH_TOKEN
      name: ${project_version}
      skip_cleanup: true
      file_glob: true
      file:
        - common-pipeline-steps/target/common-pipeline-steps_2.11-${project_version}.jar
        - spark-pipeline-engine/target/spark-pipeline-engine_2.11-${project_version}.jar
        - streaming-pipeline-drivers/target/streaming-pipeline-drivers_2.11-${project_version}.jar
